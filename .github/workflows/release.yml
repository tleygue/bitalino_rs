---
name: Release

"on":
  push:
    tags:
      - 'v*'

permissions:
  id-token: write  # Required for OIDC
  contents: write  # Needed for release uploads

jobs:
  publish:
    name: Publish for ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            artifact_name: bitalino_rs
            asset_name: bitalino-rs-linux-x86_64

    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies (Linux)
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config libdbus-1-dev libudev-dev

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build Release
        run: cargo build --release --locked

      - name: Upload Binaries
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: target/release/${{ matrix.artifact_name }}
          asset_name: ${{ matrix.asset_name }}
          tag: ${{ github.ref }}
          overwrite: true
          # This ensures the release body is only set by the first job to finish
          body: "Release generated from tag ${{ github.ref }}"

  publish-pypi:
    name: Publish Python package to PyPI
    environment: pypi  # Matches the "Environment" field on PyPI
    needs: publish
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Install system dependencies (Linux)
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config libdbus-1-dev libudev-dev

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true  # Speeds up subsequent runs

      - name: Set up Python
        run: uv python install  # Uses .python-version or pyproject.toml

      - name: Build wheels and sdist (uv + maturin backend)
        run: MATURIN_PEP517_ARGS="--release --locked" uv build --out dist

      - name: Upload wheels to GitHub Release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: dist/*
          file_glob: true
          tag: ${{ github.ref }}
          overwrite: true
          body: "Python distributions for tag ${{ github.ref }}"

      - name: Publish to PyPI (OIDC)
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist
